# ğŸ”„æ•°æ®è½¬æ¢
### [æ•°æ®é›†æ ¼å¼è¯´æ˜](https://doc.weixin.qq.com/doc/w3_AcYAwwYeABkCNRAgoXyynTKy3zgFO?scode=ABgApAe2ABEqV1BDSxAcYAwwYeABk)

 - âš ï¸âš ï¸âš ï¸ è‹¥ä»æ•°é‡‡å¹³å°ç›´æ¥å¯¼å‡ºlerobotæ ¼å¼æ•°æ®åŒ…ï¼Œå¯è·³è¿‡æ­¤ç« èŠ‚ã€‚

ğŸ¤– **Kuavo IL** æ˜¯ä¸€ä¸ªå®Œæ•´çš„æœºå™¨äººæ¨¡ä»¿å­¦ä¹ æ¡†æ¶ï¼ŒåŸºäº [LeRobot](https://github.com/huggingface/lerobot) æ„å»ºï¼Œä¸“ä¸º Kuavo äººå½¢æœºå™¨äººè®¾è®¡ã€‚è¯¥æ¡†æ¶æä¾›äº†ä»æ•°æ®è½¬æ¢ã€æ¨¡å‹è®­ç»ƒåˆ°å®é™…éƒ¨ç½²çš„å®Œæ•´å·¥å…·é“¾ã€‚

ğŸ¯ **æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸ”„ **æ•°æ®è½¬æ¢**: æ”¯æŒ ROS bag åˆ° LeRobot æ ¼å¼çš„è½¬æ¢
- ğŸš€ **ä¸€é”®è®­ç»ƒ**: æä¾›æ•°æ®è½¬æ¢ä¸æ¨¡å‹è®­ç»ƒçš„ä¸€ä½“åŒ–è§£å†³æ–¹æ¡ˆ
- ğŸ® **å®æ—¶éƒ¨ç½²**: æ”¯æŒè®­ç»ƒæ¨¡å‹åœ¨å®é™…æœºå™¨äººä¸Šçš„å®æ—¶æ¨ç†å’Œæ§åˆ¶
- ğŸ“Š **å®Œæ•´è¯„ä¼°**: æä¾›ç¦»çº¿è¯„ä¼°å’Œåœ¨çº¿éƒ¨ç½²çš„å®Œæ•´éªŒè¯æµç¨‹

ğŸ—ï¸ **é¡¹ç›®æ¶æ„**ï¼š
```
kuavo-il-opensource/
â”œâ”€â”€ kuavo/                    # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ kuavo_1convert/       # æ•°æ®è½¬æ¢å·¥å…·
â”‚   â”œâ”€â”€ kuavo_2train/         # æ¨¡å‹è®­ç»ƒå·¥å…·
â”‚   â”œâ”€â”€ kuavo_3deploy/        # æ¨¡å‹éƒ¨ç½²å·¥å…·
â”‚   â””â”€â”€ notebooks_check/      # æ•°æ®éªŒè¯ä¸å¯è§†åŒ–
â””â”€â”€ lerobot/                  # LeRobot æ¡†æ¶ 
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è®­ç»ƒç¯å¢ƒå®‰è£…
```bash
git clone https://gitee.com/leju-robot/kuavo-il-opensource.git
cd kuavo-il-opensource
```

2. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**
```bash
conda create -n kuavo_il python=3.10
conda activate kuavo_il
```

3. **å®‰è£…ä¾èµ–**
```bash
# å®‰è£… LeRobot
pip install -e lerobot
```

## ğŸ“¦ æ•°æ®å‡†å¤‡

### ç›®å½•ç»“æ„

æ¨èçš„æ•°æ®é›†ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š
```
your_task_name/
â”œâ”€â”€ rosbag/          # æ•°é‡‡å¹³å°å¯¼å‡ºè§£å‹çš„bagåŒ…
â””â”€â”€ sup_bag/         # è¾…åŠ©çš„bagåŒ…ï¼ˆå¯é€‰,å¦‚åˆ°è¾¾æœºå™¨äººèµ·å§‹å·¥ä½œä½ç½®çš„go_bagï¼‰
```

### æ•°æ®è½¬æ¢æµç¨‹

Kuavo IL æ”¯æŒä» ROS bag æ•°æ®å¿«é€Ÿè½¬æ¢ä¸º LeRobot æ ¼å¼ã€‚è½¬æ¢å‰éœ€è¦å…ˆé…ç½® `kuavo_1convert/lerobot_dataset.yaml` æ–‡ä»¶ï¼š

### é…ç½®æ–‡ä»¶
ä½¿ç”¨`lerobot_dataset.yaml`è¿›è¡Œé…ç½®ï¼š

```yaml
only_arm: true  # é»˜è®¤true, æ˜¯å¦åªä½¿ç”¨æ‰‹è‡‚æ•°æ®, ç›®å‰çš„æ¨¡ä»¿å­¦ä¹ åªç”¨äºæ‰‹è‡‚æ•°æ®
eef_type: dex_hand # or leju_claw
which_arm: both  # å¯é€‰: left, right, both

# task_description: "Pick the black workpiece from the white conveyor belt on your left and place it onto the white box in front of you"
task_description: "Place the black workpiece from the white desk onto the electronic scale, then move the it to the left white conveyor belt"

train_hz: 10  # è®­ç»ƒé‡‡æ ·é¢‘ç‡
main_timeline_fps: 30 # ä¸»ç›¸æœºçš„å¸§ç‡ï¼Œå¿…é¡»ç¨³å®š, ä¸»ç›¸æœºæ¥è‡ªhead_cam_h, wrist_cam_l, wrist_cam_r
sample_drop: 10 # ä¸¢å¼ƒå›åˆå‰åçš„10å¸§

# dex_dof_neededæ˜¯å¼ºè„‘æ‰‹éœ€è¦çš„è‡ªç”±åº¦æ•°ç›®ã€‚å¼ºè„‘çµå·§æ‰‹æœ‰6ä¸ªè‡ªç”±åº¦ã€‚æ ‡å‡†æ¡æ‹³çŠ¶æ€[100] * 6, å¼ å¼€çŠ¶æ€[0] * 6ã€‚
# 1: ä¸éœ€è¦ç²¾ç»†æ“ä½œæˆ–è€…å¤šæŒ‡ååŒæ“ä½œæ—¶ï¼Œé€šå¸¸ä¸ºè®¾ç½®ä¸º1ï¼Œè¡¨ç¤ºåªéœ€è¦ç¬¬ä¸€ä¸ªå…³èŠ‚ä½œä¸ºå¼€åˆä¾æ®,æ­¤æ—¶éœ€è¦ç”¨[0, 100, 0, 0, 0, 0]è¡¨ç¤ºå¼ å¼€çŠ¶æ€, [100] * 6è¡¨ç¤ºæ¡æ‹³çŠ¶æ€ã€‚
# 2(æš‚æœªæµ‹è¯•): æˆ–è€…è®¾ç½®ä¸º2ï¼Œç›®å‰çš„æ‰‹æŸ„é¥æ“ä½œåªæœ‰ä¸¤ä¸ªè‡ªç”±åº¦ã€‚0,2,3,4,5è‡ªç”±åº¦ç»‘å®šä¸º1ä¸ªè‡ªç”±åº¦ã€‚
# 6(æš‚æœªæµ‹è¯•): å¦‚æœè„±ç¦»æ‰‹æŸ„ä½¿ç”¨æ‰‹æŒ‡çµå·§æ“ä½œï¼Œå¯ä»¥è®¾ç½®ä¸º6ï¼Œè¡¨ç¤ºéœ€è¦æ‰€æœ‰6ä¸ªè‡ªç”±åº¦ã€‚
dex_dof_needed: 1   # default=1

is_binary: false  # æ˜¯å¦å°†å¼€åˆäºŒå€¼åŒ–, default=false
delta_action: false # æ˜¯å¦ä½¿ç”¨å¢é‡åŠ¨ä½œï¼Œdefault=false
relative_start: false # æ˜¯å¦ä½¿ç”¨ç›¸å¯¹èµ·å§‹ä½ç½®, default=false

resize:
  width: 848
  height: 480
```

#### ä¸»è¦é…ç½®é¡¹è¯´æ˜
- `eef_type`: æœ«ç«¯æ‰§è¡Œå™¨ç±»å‹ï¼Œå¯é€‰'dex_hand'ï¼ˆçµå·§æ‰‹ï¼‰æˆ–'leju_claw'ï¼ˆä¹èšå¤¹çˆªï¼‰
- `which_arm`: ä½¿ç”¨çš„æ‰‹è‡‚ï¼Œå¯é€‰'left'ï¼ˆå·¦è‡‚ï¼‰ã€'right'ï¼ˆå³è‡‚ï¼‰æˆ–'both'ï¼ˆåŒè‡‚ï¼‰
- `train_hz`: è®­ç»ƒæ•°æ®çš„é‡‡æ ·é¢‘ç‡
- `main_timeline`: ç”¨äºæ—¶é—´å¯¹é½çš„ä¸»æ—¶é—´çº¿è¯é¢˜
- `dex_dof_needed`: çµå·§æ‰‹ä½¿ç”¨çš„è‡ªç”±åº¦æ•°é‡

### è½¬æ¢ä»£ç 
`Zed`: å¦‚æœç›¸æœºæ˜¯zedç›¸æœºï¼Œéœ€è¦æŠŠ`kuavo/kuavo_1convert/common/config_dataset.py`ç¬¬51è¡Œ`cameras = ['head_cam_h']`ä¿®æ”¹ä¸º`cameras = ['head_cam_l']`
```bash
# è½¬æ¢ ROS bag åˆ° LeRobot æ ¼å¼
python kuavo/kuavo_1convert/cvt_rosbag2lerobot.py --raw_dir RAW_DIR [-n NUM_OF_BAG] [-v PROCESS_VERSION]

# ä¾‹:
python kuavo/kuavo_1convert/cvt_rosbag2lerobot.py  --raw_dir kuavo/kuavo_1convert/Task0_example/rosbag -v v_example
```
å¿…é€‰å‚æ•°:
  --raw_dir RAW_DIR    åŸå§‹ROSåŒ…ç›®å½•è·¯å¾„

å¯é€‰å‚æ•°:
  -n NUM_OF_BAG       è¦å¤„ç†çš„åŒ…æ–‡ä»¶æ•°é‡
  -v PROCESS_VERSION  å¤„ç†ç‰ˆæœ¬ï¼ˆé»˜è®¤'v0'ï¼Œ'v_example'æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼‰

**æ³¨**:è½¬æ¢åçš„lerobotæ•°æ®åœ¨æŒ‡å®šå­˜æ”¾åœ¨è£…è½½RosBagæ•°æ®é›†çš„æ–‡ä»¶å¤¹çš„åŒçº§ç›®å½•ï¼Œæœ¬æ¡ˆä¾‹çš„è½¬æ¢åç›®å½•ç»“æ„å¦‚ä¸‹
```bash
kuavo/kuavo_1convert/Task0_example
â”œâ”€â”€ rosbag
â”‚   â””â”€â”€ example.bag
â””â”€â”€ v_example
    â””â”€â”€ lerobot
        â”œâ”€â”€ data
        â”‚   â””â”€â”€ chunk-000
        â”‚       â””â”€â”€ episode_000000.parquet
        â”œâ”€â”€ meta
        â”‚   â”œâ”€â”€ episodes.jsonl
        â”‚   â”œâ”€â”€ info.json
        â”‚   â”œâ”€â”€ stats.json
        â”‚   â””â”€â”€ tasks.jsonl
        â””â”€â”€ videos
            â””â”€â”€ chunk-000
                â”œâ”€â”€ observation.images.head_cam_h
                â”‚   â””â”€â”€ episode_000000.mp4
                â””â”€â”€ observation.images.wrist_cam_r
                    â””â”€â”€ episode_000000.mp4
```

è½¬æ¢å®Œæˆåå¯ä»¥å¯è§†åŒ–æ•°æ®é›†ï¼š
```bash
# å¯è§†åŒ–è½¬æ¢å®Œæ¯•çš„ lerobot datasetï¼š
python lerobot/lerobot/scripts/visualize_dataset.py --repo-id lerobot/Task0_example --root kuavo/kuavo_1convert/Task0_example/v_example/lerobot  --episode 0 --local-files-only 1
```
è¿™æ˜¯Task0_exampleçš„å¯è§†åŒ–:
![alt text](docs/Task0_example_lerobot.png)
ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŒè‡‚æ“ä½œçš„å¯è§†åŒ–ç¤ºä¾‹:
![4cam: plst-check](docs/vis_le.png)

### bagè½¬æ¢zarr(æ­¤æ¡ˆä¾‹ä¸»çº¿æœªä½¿ç”¨zarræ ¼å¼ï¼Œä»…åšæ¼”ç¤º)

1.è¿›å…¥ä»“åº“

```bash
cd kuavo-il-opensource
```
2.è¿›è¡Œæ ¼å¼è½¬æ¢

```bash
python /home/lejurobot/tjy/kuavo-il-opensource/kuavo/kuavo_1convert/cvt_rosbag2zarr.py -b /home/lejurobot/mydisk/data/Task17_cup/rosbag -c /home/lejurobot/tjy/kuavo-il-opensource/kuavo/kuavo_1convert/config/Task14_cup.yaml -n 3 -a
```
**[æ³¨]**: è½¬æ¢ä»£ç æ ¼å¼å¦‚ä¸‹

```bash
Python [è½¬æ¢è„šæœ¬]  
-b [bagæ•°æ®é›†æ–‡ä»¶] 
-c [é…ç½®æ–‡ä»¶è·¯å¾„(æ ¹æ®bagè¯é¢˜ä¿®æ”¹å¯¹åº”çš„yamlæ–‡ä»¶ï¼Œå†…åŒ…å«ä¸åŒè¯é¢˜çš„å¤„ç†æ–¹æ³•ä»¥åŠæŠ½å¸§å€¼)] 
-n [éœ€è¦å¤„ç†çš„bagåŒ…æ•°é‡]
-a [å¦‚æœéœ€è¦åˆå¹¶å¤šä¸ªä»»åŠ¡çš„æ•°æ®ï¼Œè¿™é‡Œå¯ä»¥åŠ ä¸Š-a] 
-l [å›¾åƒçš„å‹ç¼©è´¨é‡ï¼Œè¶Šå°è´¨é‡è¶Šä½(0-100)]
```
