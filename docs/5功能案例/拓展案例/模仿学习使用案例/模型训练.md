# ğŸ§  æ¨¡å‹è®­ç»ƒ

ğŸ¤– **Kuavo IL** æ˜¯ä¸€ä¸ªå®Œæ•´çš„æœºå™¨äººæ¨¡ä»¿å­¦ä¹ æ¡†æ¶ï¼ŒåŸºäº [LeRobot](https://github.com/huggingface/lerobot) æ„å»ºï¼Œä¸“ä¸º Kuavo äººå½¢æœºå™¨äººè®¾è®¡ã€‚è¯¥æ¡†æ¶æä¾›äº†ä»æ•°æ®è½¬æ¢ã€æ¨¡å‹è®­ç»ƒåˆ°å®é™…éƒ¨ç½²çš„å®Œæ•´å·¥å…·é“¾ã€‚

ğŸ¯ **æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸ”„ **æ•°æ®è½¬æ¢**: æ”¯æŒ ROS bag åˆ° LeRobot æ ¼å¼çš„è½¬æ¢
- ğŸš€ **ä¸€é”®è®­ç»ƒ**: æä¾›æ•°æ®è½¬æ¢ä¸æ¨¡å‹è®­ç»ƒçš„ä¸€ä½“åŒ–è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå¤šç§ç­–ç•¥æ¨¡å‹(ACT, Diffusion)
- ğŸ® **å®æ—¶éƒ¨ç½²**: æ”¯æŒè®­ç»ƒæ¨¡å‹åœ¨å®é™…æœºå™¨äººä¸Šçš„å®æ—¶æ¨ç†å’Œæ§åˆ¶
- ğŸ“Š **å®Œæ•´è¯„ä¼°**: æä¾›ç¦»çº¿è¯„ä¼°å’Œåœ¨çº¿éƒ¨ç½²çš„å®Œæ•´éªŒè¯æµç¨‹

ğŸ—ï¸ **é¡¹ç›®æ¶æ„**ï¼š
```
kuavo-il-opensource/
â”œâ”€â”€ kuavo/                    # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ kuavo_1convert/       # æ•°æ®è½¬æ¢å·¥å…·
â”‚   â”œâ”€â”€ kuavo_2train/         # æ¨¡å‹è®­ç»ƒå·¥å…·
â”‚   â”œâ”€â”€ kuavo_3deploy/        # æ¨¡å‹éƒ¨ç½²å·¥å…·
â”‚   â””â”€â”€ notebooks_check/      # æ•°æ®éªŒè¯ä¸å¯è§†åŒ–
â””â”€â”€ lerobot/                  # LeRobot æ¡†æ¶ 
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è®­ç»ƒç¯å¢ƒå®‰è£…

1. **å…‹éš†ä»“åº“**
```bash
git clone https://gitee.com/leju-robot/kuavo-il-opensource.git
cd kuavo-il-opensource
```

2. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**
```bash
conda create -n kuavo_il python=3.10
conda activate kuavo_il
```

3. **å®‰è£…ä¾èµ–**
```bash
# å®‰è£… LeRobot
pip install -e lerobot
```
## ğŸ§  æ¨¡å‹è®­ç»ƒ

### å•å¡è®­ç»ƒ

#### åŸºç¡€è®­ç»ƒå‘½ä»¤

1. **è¿›å…¥é¡¹ç›®æ ¹ç›®å½•**
```bash
cd kuavo-il-opensource
```

2. **æ‰§è¡Œè®­ç»ƒå‘½ä»¤**
```bash
python lerobot/lerobot/scripts/train.py \
    --policy.type act \
    --dataset.repo_id kuavo/Task0_example \
    --dataset.local_files_only true \
    --dataset.root kuavo/kuavo_1convert/Task0_example/v_example/lerobot/ \
    --save_checkpoint true \
    --batch_size 32 \
    --num_workers 8 \
    --output_dir kuavo/kuavo_1convert/Task0_example/v_example/ \
    --steps 200000 \
    --save_freq 20000 \
    --log_freq 200
```

#### å¯ç”¨ WandB ç›‘æ§ï¼ˆå¯é€‰ï¼‰
å¦‚æœéœ€è¦è®°å½•è®­ç»ƒè¿‡ç¨‹ï¼Œå¯ä»¥åŠ ä¸Š`--wandb.enable true` `--wandb.project Task0_example`å‚æ•°ã€‚å¦éœ€åœ¨ç»ˆç«¯`wandb login`æ ¹æ®æç¤ºè¾“å…¥API keyç™»å½•wandbè´¦æˆ·ã€‚
```bash
python lerobot/lerobot/scripts/train.py \
    --policy.type act \
    --dataset.repo_id kuavo/Task0_example \
    --dataset.local_files_only true \
    --dataset.root kuavo/kuavo_1convert/Task0_example/v_example/lerobot/ \
    --wandb.enable true \
    --wandb.project Task0_example \
    --save_checkpoint true \
    --batch_size 32 \
    --num_workers 8 \
    --output_dir kuavo/kuavo_1convert/Task0_example/v_example/ \
    --steps 200000 \
    --save_freq 20000 \
    --log_freq 200
```
è‹¥ç½‘ç»œä¸å…è®¸å®æ—¶ä¸Šä¼ wandbï¼Œå¯ä»¥åœ¨ç»ˆç«¯è¾“å…¥`wandb offline`ï¼Œä»ç„¶ä½¿ç”¨`--wandb.enable true` `--wandb.project Task0_example`å‚æ•°é…ç½®ï¼Œè¿™ä¼šæŠŠwandbå­˜åœ¨`æ¨¡å‹è¾“å‡ºç›®å½•`é‡Œï¼Œä¹‹åæŸ¥çœ‹å¯ä»¥`wandb sync wand/latest-run/`åŒæ­¥åˆ°wandbç½‘ç«™æŸ¥çœ‹
#### å‚æ•°è¯´æ˜

|            å‚æ•°            |                            æè¿°                            |                         ç¤ºä¾‹å€¼                         |
| :------------------------: | :--------------------------------------------------------: | :----------------------------------------------------: |
|       `policy.type`        |                 policyç±»å‹(act/diffusion)                 |                          act                           |
|     `dataset.repo_id`      | ä»hfä¸Šæ‹‰æ•°æ®éœ€è¦ï¼Œå¦‚æœä½¿ç”¨æœ¬åœ°æ•°æ®å¯ä»¥å¡«<kuavo/TaskName> |          kuavo/Task0_example          |
| `dataset.local_files_only` |                    é»˜è®¤ä½¿ç”¨æœ¬åœ°æ•°æ®è®­ç»ƒ                    |                         `true`                         |
|       `dataset.root`       |                   æœ¬åœ°lerobotæ•°æ®é›†è·¯å¾„                    | kuavo/kuavo_1convert/Task0_example/v_example/lerobot/ |
|     `save_checkpoint`      |                      æ˜¯å¦éœ€è¦å­˜å‚¨ckpt                      |                          true                          |
|        `batch_size`        |                     æ¨¡å‹è®­ç»ƒbatchå¤§å°                      |                           32                           |
|       `num_workers`        |                    æ•°æ®åŠ è½½ä½¿ç”¨cpuæ•°é‡                     |                           8                            |
|        `output_dir`        |                        æ¨¡å‹è¾“å‡ºç›®å½•                        |     kuavo/kuavo_1convert/Task0_example/v_example      |
|       `wandb.enable`       |         æ˜¯å¦éœ€è¦ä½¿ç”¨wandbè®°å½•è®­ç»ƒè¿‡ç¨‹,é»˜è®¤`false`          |                         `true`                         |
|      `wandb.project`       |                     ä¸ºæœ¬æ¬¡è®­ç»ƒè¿‡ç¨‹å‘½å                     |              Task0_example              |
|          `steps`           |          æ€»è®­ç»ƒé‡‡æ ·batchæ¬¡æ•°ï¼Œä¸€èˆ¬100000ï½200000           |                         200000                         |
|        `save_freq`         |    æ¯20000é‡‡æ ·å­˜å‚¨ä¸€æ¬¡è®­ç»ƒç»“æœï¼Œå¯ä»¥å–ä¸­é—´è®­ç»ƒç»“æœéªŒè¯     |                         20000                          |
|         `log_freq`         |           æ¯200æ¬¡é‡‡æ ·logä¸€æ¬¡lossç­‰æ•°æ®æ˜¾ç¤ºåˆ°ç»ˆç«¯           |                          200                           |

4. è®­ç»ƒå¦‚ä¸‹å›¾æ‰€ç¤º

![image-20250417171955671](./docs/single.png)

### å¤šå¡åˆ†å¸ƒå¼è®­ç»ƒ

#### åŸºç¡€åˆ†å¸ƒå¼è®­ç»ƒå‘½ä»¤

1. **è¿›å…¥é¡¹ç›®æ ¹ç›®å½•**
```bash
cd kuavo-il-opensource
```

2. **è®¾ç½®GPUç¯å¢ƒå¹¶æ‰§è¡Œè®­ç»ƒ**
```bash
# ç¤ºä¾‹å‘½ä»¤ï¼Œå¦‚æœæ˜¾å¡æ•°é‡å¤§äº >=4ï¼Œä½¿ç”¨å‰4å¼ GPUè¿›è¡Œåˆ†å¸ƒå¼è®­ç»ƒã€‚
export CUDA_VISIBLE_DEVICES=0,1,2,3 GPUS=4
accelerate launch --num_processes=$GPUS --main_process_port 29399 --mixed_precision fp16 \
    lerobot/lerobot/scripts/train_distributed.py \
    --policy.type act \
    --dataset.repo_id kuavo/Task0_example \
    --dataset.local_files_only true \
    --dataset.root kuavo/kuavo_1convert/Task0_example/v_example/lerobot/ \
    --save_checkpoint true \
    --batch_size 32 \
    --num_workers 8 \
    --output_dir kuavo/kuavo_1convert/Task0_example/v_example/ \
    --epochs 500 \
    --save_epoch 50
```

#### å¯ç”¨ WandB ç›‘æ§ï¼ˆå¯é€‰ï¼‰
```bash
export CUDA_VISIBLE_DEVICES=0,1,2,3 GPUS=4
accelerate launch --num_processes=$GPUS --main_process_port 29399 --mixed_precision fp16 \
    lerobot/lerobot/scripts/train_distributed.py \
    --policy.type act \
    --dataset.repo_id kuavo/Task0_example \
    --dataset.local_files_only true \
    --dataset.root kuavo/kuavo_1convert/Task0_example/v_example/lerobot/ \
    --wandb.enable true \
    --wandb.project Task0_example \
    --save_checkpoint true \
    --batch_size 32 \
    --num_workers 8 \
    --output_dir kuavo/kuavo_1convert/Task0_example/v_example/ \
    --epochs 500 \
    --save_epoch 50
```

#### åˆ†å¸ƒå¼è®­ç»ƒå‚æ•°è¯´æ˜

|            å‚æ•°            |           æè¿°           |                       ç¤ºä¾‹å€¼                        |
| :------------------------: | :----------------------: | :-------------------------------------------------: |
|      `num_processes`       |   è®­ç»ƒæ—¶ä½¿ç”¨çš„GPUæ•°é‡    |                         3                         |
|    `main_process_port`     |   æ‰§è¡Œè®­ç»ƒè¿›ç¨‹çš„ç«¯å£å·   |                       29599                       |
| `mixed_precision` |   æ˜¯å¦ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ   |                       fp16                        |
| `policy.type` |   policyç±»å‹(act/diffusion)  |                         act                         |
| `dataset.repo_id` |    ä»hfä¸Šæ‹‰æ•°æ®éœ€è¦ï¼Œå¦‚æœä½¿ç”¨æœ¬åœ°æ•°æ®å¯ä»¥å¡«<TaskName/lerobot>  |                       kuavo/Task0_example                      |
| `dataset.local_files_only` |  é»˜è®¤ä½¿ç”¨æœ¬åœ°æ•°æ®è®­ç»ƒ    |                       `true`                        |
| `dataset.root` | æœ¬åœ°lerobotæ•°æ®é›†è·¯å¾„ |              kuavo/kuavo_1convert/Task0_example/v_example/lerobot/              |
|       `save_checkpoint`       |   æ˜¯å¦éœ€è¦å­˜å‚¨ckpt       |   true   |
|        `batch_size`        |    æ¨¡å‹è®­ç»ƒbatchå¤§å°        | 32 |
| `num_workers` |    æ•°æ®åŠ è½½ä½¿ç”¨cpuæ•°é‡   |                         8                         |
| `output_dir` |    æ¨¡å‹è¾“å‡ºç›®å½•  |                       kuavo/kuavo_1convert/Task0_example/v_example/                       |
| `wandb.enable` |   æ˜¯å¦éœ€è¦ä½¿ç”¨wandbè®°å½•è®­ç»ƒè¿‡ç¨‹,é»˜è®¤`false`   |                       `true`                        |
| `wandb.project` | ä¸ºæœ¬æ¬¡è®­ç»ƒè¿‡ç¨‹å‘½å |              Task0_example              |
|       `epochs`       |   è®­ç»ƒè½®æ•°(æ•°æ®é›†éå†ä¸€è½®)   |   600   |
|        `save_epoch`        |    æ¯50è½®å­˜å‚¨ä¸€æ¬¡è®­ç»ƒç»“æœ        | 50 |

4.æˆåŠŸå¯åŠ¨è®­ç»ƒåˆ™æ˜¾ç¤ºä¸‹å›¾

![image-20250417171955671](./docs/multi.png)



## ğŸ“Š æ€§èƒ½è¯„ä¼°(å¯é€‰æ­¥éª¤)

### ç¦»çº¿è¯„ä¼°

å¯ä»¥åœ¨è®­ç»ƒçš„æ—¶å€™é€‰å–éƒ¨åˆ†æ•°æ®é›†ä¸å‚ä¸è®­ç»ƒï¼Œè½¬åŒ–ä¸ºlerobotæ ¼å¼åè¿›è¡Œç¦»çº¿è¯„ä¼°ä½œä¸ºåˆæ­¥æ¨¡å‹çš„æ€§èƒ½éªŒè¯ã€‚

ä½¿ç”¨ Jupyter Notebook è¿›è¡Œç¦»çº¿è¯„ä¼°ï¼š
è¿›å…¥ `kuavo/notebooks_check/` ç›®å½•ï¼Œæ‰“å¼€ `offlineEval_LeRobot.ipynb`ï¼š
1. ä¿®æ”¹æ•°æ®é›†è·¯å¾„å’Œæ¨¡å‹è·¯å¾„
    ```python
    class EvalConfig:
        """Evaluation configuration parameters"""
        
        # Dataset configuration
        dataset_root: str = "/Users/calmzeal/camille/code/kuavo_il/kuavo/kuavo_1convert/Task0_example/v_example/lerobot"
        local_files_only: bool = True
        
        # Model configuration
        model_checkpoint_path: str = "/Users/calmzeal/camille/code/kuavo_il/kuavo/kuavo_1convert/Task0_example/v_example/2025-08-05/22-12-36_act/checkpoints/000010/pretrained_model"
        
        # Evaluation configuration
        selected_episodes_num: int = 4  # éœ€è¦å¯è§†åŒ–çš„episodeæ•°é‡
        random_seed: int = 42
        
        # Data preprocessing configuration
        joint_slice_range: List[int] = field(default_factory=lambda: [0, 16])   # æ¨¡å‹è¾“å…¥çš„ç»´åº¦
        fps: int = 10   # æ¨¡å‹è®­ç»ƒæ—¶çš„å¸§ç‡
        
        # Noise configuration
        image_noise_level: float = 0.0
        state_noise_scale: float = 0.0
        
        # Timestamp configuration - convenient for adjusting sensor data
        camera_sensors: Dict[str, bool] = field(default_factory=lambda: {
            "head_cam_l": False,  # Enable head left camera
            "wrist_cam_r": True,   # Enable wrist right camera
            "wrist_cam_l": True,   # Enable wrist left camera
            "head_cam_h": True,    # Enable head main camera
        })
        
        # Visualization configuration
        # [(0, 8), (13, 21)]ï¼Œè¡¨ç¤ºå·¦æ‰‹å’Œå³æ‰‹çš„å…³èŠ‚ç»„ã€‚å¦‚æœæ˜¯å•æ‰‹é‚£ä¹ˆå°±åªéœ€è¦ä¸€ä¸ªå…³èŠ‚ç»„ï¼Œä¾‹å¦‚ [(0, 8)]
        visualization_joint_groups: List[List[int]] = field(default_factory=lambda: [(0, 8), (13, 21)])
        show_image_samples: int = 14    # è¡¨ç¤ºå¯è§†åŒ–å›¾åƒçš„æ•°é‡
        
        # Device configuration
        device: str = "cuda:0" if torch.cuda.is_available() else "cpu"
    ```
2. è¿è¡Œæ‰€æœ‰å•å…ƒæ ¼è¿›è¡Œè¯„ä¼°,æœ€ç»ˆç»˜å›¾å¾—åˆ°ç±»ä¼¼ä¸‹å›¾çš„ç¦»çº¿è¯„ä¼°ç»“æœ(å¦‚å›¾æ‰€ç¤º)ï¼š
    ![ç¦»çº¿è¯„ä¼°ç»“æœ](docs/offline_eval_result.png)